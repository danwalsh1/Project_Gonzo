package com.example.jacob.projectgonzo;

import android.content.Intent;
import android.os.BatteryManager;
import android.os.Build;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.widget.TextView;
import android.content.BroadcastReceiver;
import android.content.IntentFilter;
import android.content.Context;
import android.net.Uri;
import android.view.View;

import java.util.Date;
import java.util.Calendar;

public class MainActivity extends AppCompatActivity {
    //Initialises variables with varying types.
    String Address;
    public int level;
    String NameOfPhone = Build.ID; //Sets the phones name equal to the NameOfPhone variable. - THIS ISNT GOING TO WORK AS THE WEBSITES MAKES THE DEVICE ID ALL ONE WORD AND THE DEVICE ID FOR THIS APP IS MORE THAN ONE WORD.
    String state;                   //think the above works. although data isnt showing on the website for some reason.
    public boolean isCharging;
    public int ChargeState;
    public int CountdownAmount = 60; //Seconds for the countdown.

    public BroadcastReceiver BatteryChange = new BroadcastReceiver() {
        @Override
        public void onReceive(Context c, Intent i) {

            //For future reference the battery level is stored inside the 'level' variable.
            //Get the battery level and assign it to the 'level' variable. If the program cannot get a level it will set the battery level to 0 by default.
            level = i.getIntExtra("level", 0);
            //Find textview control created in activity_main.xml
            TextView tv = (TextView) findViewById(R.id.BatteryLevel);
            //Set the BatteryLevel text field as 'Battery level *batterylevelhere* %'.
            tv.setText("Battery Level: " + Integer.toString(level) + "%");

            //Finding the charge state.
            int status = i.getIntExtra(BatteryManager.EXTRA_STATUS, -1);
            isCharging = status == BatteryManager.BATTERY_STATUS_CHARGING ||
                    status == BatteryManager.BATTERY_STATUS_FULL;
            if (isCharging == true) {
                state = "Charging.";
                ChargeState = 1;
            }else if (isCharging == false) {
                state = "Not Charging.";
                ChargeState = 0;
            }
            TextView cs = (TextView) findViewById(R.id.ChargeState);
            cs.setText("Charge State: "+state);
        }
    };

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        //Register the receiver which triggers the event 'BatteryChange' when the battery level changes. This in turn then changes the text on the screen to say the now current battery life.
        registerReceiver(BatteryChange, new IntentFilter(Intent.ACTION_BATTERY_CHANGED));
        TextView tv = (TextView) findViewById(R.id.DeviceID);
        tv.setText("Your Device ID is: "+NameOfPhone);
        TextView cd = (TextView) findViewById(R.id.Countdown);
        cd.setText("Data sent at: WAITING ON BUTTON PRESS.");
    }

    public void OpenBrowser(View view){
        //Creates a new browser session that opens a certain website.
        Address = "https://projectgonzocoventry.000webhostapp.com/app_page/insertData.php?deviceid="+NameOfPhone+"&batlevel="+level+"&chargestate="+ChargeState;
        Intent browserIntent=new Intent(Intent.ACTION_VIEW, Uri.parse(Address));
        startActivity(browserIntent);

        Date CurrentTime = Calendar.getInstance().getTime();
        TextView cd = (TextView) findViewById(R.id.Countdown);
        cd.setText("Data sent at: "+CurrentTime);


        Thread loop=new Thread(){
            @Override
            public void run(){
                while(!isInterrupted()){
                    try {
                        Thread.sleep(CountdownAmount*1000*60);  //1000ms = 1 sec //Every hour this thread is run which opens the browser.
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                Intent browserIntent=new Intent(Intent.ACTION_VIEW, Uri.parse(Address));
                                startActivity(browserIntent);
                            }
                        });
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        };

        loop.start(); //loop called for data sending.
    }

}
